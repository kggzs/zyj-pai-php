# 创建管理员账号

## 概述

`create_admin.php` 是一个用于创建系统管理员账号的专用脚本。该脚本采用两步验证机制，确保只有授权人员才能创建管理员账号。

## 功能特点

### 两步验证机制

脚本采用两步验证流程，提高安全性：

1. **第一步：脚本专属密码验证**
   - 需要输入预设的脚本专属密码
   - 验证成功后进入第二步
   - 验证状态保存在 Session 中，有效期为 10 分钟

2. **第二步：创建管理员账号**
   - 输入管理员用户名、密码、邮箱
   - 所有字段均为必填项
   - 创建成功后自动清除验证状态

### 安全特性

#### 密码保护

- 脚本专属密码在文件顶部定义：`SCRIPT_PASSWORD`
- **重要提示**：部署前必须修改默认密码
- 默认密码：`Admin2024Secure!@#`

#### Session 验证

- 使用 Session 保存验证状态
- 验证状态有效期为 10 分钟
- 超时后需要重新验证脚本专属密码

#### 输入验证

- **用户名验证**：
  - 长度：3-20 个字符
  - 格式：只能包含字母、数字和下划线
  - 唯一性：检查用户名是否已存在

- **密码验证**：
  - 使用 `Security::validatePasswordStrength()` 验证密码强度
  - 如果 Security 类不可用，则使用简单验证（至少 6 个字符）
  - 前端实时显示密码强度（弱/中/强）

- **邮箱验证**：
  - 使用 PHP `filter_var()` 验证邮箱格式
  - 检查邮箱是否已被使用

### 账号属性

创建的管理员账号具有以下默认属性：

- **管理员权限**：`is_admin = 1`
- **VIP 状态**：`is_vip = 1`（永久 VIP）
- **VIP 到期时间**：`vip_expire_time = NULL`（永久有效）
- **账号状态**：`status = 1`（正常）
- **邮箱验证**：`email_verified = 1`（已验证）
- **初始积分**：`points = 0`

### 用户界面

#### 步骤指示器

页面顶部显示当前步骤：
- 步骤 1：验证密码
- 步骤 2：创建账号

#### 信息提示框

- 蓝色提示框显示操作说明
- 错误信息以红色显示
- 成功信息以绿色显示

#### 密码强度检测

- 实时显示密码强度（弱/中/强）
- 使用颜色条显示强度等级
- 强度判断标准：
  - 长度 ≥ 6 字符
  - 长度 ≥ 8 字符
  - 包含大小写字母
  - 包含数字
  - 包含特殊字符

## 使用方法

### 1. 修改脚本专属密码

在部署前，必须修改 `create_admin.php` 文件中的脚本专属密码：

```php
define('SCRIPT_PASSWORD', 'Admin2024Secure!@#'); // 请修改此密码
```

建议使用强密码，包含大小写字母、数字和特殊字符。

### 2. 访问创建页面

在浏览器中访问：

```
http://your-domain/create_admin.php
```

### 3. 第一步：验证脚本专属密码

- 输入脚本专属密码
- 点击"下一步"按钮
- 验证成功后进入第二步

### 4. 第二步：创建管理员账号

填写以下信息：

- **用户名**：3-20 个字符，只能包含字母、数字和下划线
- **密码**：符合密码强度要求
- **邮箱**：有效的邮箱地址

点击"创建管理员账号"按钮完成创建。

## 注意事项

### 安全建议

1. **修改默认密码**：部署前必须修改脚本专属密码
2. **限制访问**：建议通过 IP 白名单或 .htaccess 限制访问
3. **使用后删除**：创建管理员账号后，建议删除或重命名此文件
4. **HTTPS 访问**：必须通过 HTTPS 访问此页面（核心功能必须在HTTPS下才可使用，本地测试除外）

### 错误处理

常见错误及解决方法：

- **"脚本专属密码不正确！"**：检查输入的密码是否正确
- **"验证已过期"**：验证状态超过 10 分钟，需要重新验证
- **"用户名已存在！"**：该用户名已被使用，请选择其他用户名
- **"该邮箱已被使用！"**：该邮箱已被注册，请使用其他邮箱
- **"密码长度至少6个字符！"**：密码不符合强度要求

### 数据库要求

确保数据库表 `users` 已正确创建，包含以下字段：

- `username`：用户名
- `password`：密码（哈希值）
- `email`：邮箱
- `email_verified`：邮箱验证状态
- `register_ip`：注册 IP
- `register_ua`：注册 User-Agent
- `register_time`：注册时间
- `last_login_time`：最后登录时间
- `status`：账号状态
- `is_admin`：是否管理员
- `points`：积分
- `is_vip`：是否 VIP
- `vip_expire_time`：VIP 到期时间

## 技术实现

### 核心类依赖

- `Database`：数据库操作
- `Security`：安全功能（密码验证、IP 获取）
- `Helper`：辅助函数（项目名称获取）

### Session 管理

```php
// 保存验证状态
$_SESSION['admin_create_verified'] = true;
$_SESSION['admin_create_verified_time'] = time();

// 检查验证状态（10分钟超时）
if (time() - $_SESSION['admin_create_verified_time'] > 600) {
    // 验证已过期
}
```

### 密码哈希

使用 PHP `password_hash()` 函数生成密码哈希：

```php
$hashedPassword = password_hash($password, PASSWORD_DEFAULT);
```

### 账号创建 SQL

```sql
INSERT INTO users (
    username, password, email, email_verified,
    register_ip, register_ua, register_time, last_login_time,
    status, is_admin, points, is_vip, vip_expire_time
) VALUES (?, ?, ?, 1, ?, ?, ?, ?, 1, 1, 0, 1, NULL)
```

## 相关文件

- `admin_login.php`：管理员登录页面
- `admin.php`：管理员后台页面
- `core/Security.php`：安全功能类
- `core/Database.php`：数据库操作类

## 更新日志

- 初始版本：支持两步验证创建管理员账号
- 自动设置为永久 VIP 会员
- 支持密码强度检测
- 支持用户名和邮箱格式验证

