# 安全功能模块

安全功能模块提供全面的安全防护功能，保护系统免受各种攻击。

## 功能概述

### 1. API频率限制（Rate Limiting）

#### 功能说明
- 限制API接口的访问频率
- 防止恶意请求和暴力破解
- 基于IP地址进行限制

#### 限制规则
- 每个IP地址在指定时间窗口内的请求次数限制
- 超过限制后返回错误，需要等待一段时间后才能继续请求

### 2. CSRF防护

#### 功能说明
- 防止跨站请求伪造攻击
- 使用Token机制验证请求来源

#### 实现方式
- 生成CSRF Token
- 在表单中包含Token
- 验证请求中的Token

### 3. SQL注入防护

#### 功能说明
- 使用PDO预处理语句
- 参数化查询，防止SQL注入

#### 实现方式
- 所有数据库查询都使用预处理语句
- 参数通过占位符绑定，不直接拼接SQL

### 4. XSS防护

#### 功能说明
- 防止跨站脚本攻击
- 对输出内容进行转义

#### 实现方式
- 输出HTML时使用`htmlspecialchars`转义
- 过滤用户输入的HTML标签

### 5. Session安全

#### 功能说明
- 安全的Session配置
- 防止会话固定攻击

#### 实现方式
- 登录时重新生成Session ID
- Session配置安全参数
- 使用HttpOnly Cookie

### 6. 密码安全

#### 功能说明
- 安全的密码存储和验证

#### 实现方式
- 使用`password_hash`加密密码
- 使用`password_verify`验证密码
- 密码强度验证

### 7. 文件上传安全

#### 功能说明
- 验证上传文件类型和大小
- 防止恶意文件上传

#### 实现方式
- 白名单验证文件类型
- 限制文件大小
- 验证文件内容

### 8. 异常行为检测

#### 功能说明
- 检测和记录异常行为
- 包括多次失败登录、异常IP登录等

#### 检测类型
- 多次失败登录
- 异常IP登录
- 其他异常行为

### 9. 登录日志

#### 功能说明
- 记录所有登录尝试
- 包括成功和失败的登录

#### 记录信息
- 用户ID（如果存在）
- 登录IP
- 登录User-Agent
- 登录时间
- 登录结果（成功/失败）
- 失败原因

### 10. 请求签名验证（可选）

#### 功能说明
- 可选的API请求签名验证
- 增强API安全性

#### 实现方式
- 使用密钥生成请求签名
- 验证请求签名和时间戳

## 核心类

### Security类

位置：`core/Security.php`

主要方法：
- `getClientIp()`：获取客户端IP（兼容CDN和反向代理）
- `validatePasswordStrength($password)`：验证密码强度
- `generateCSRFToken()`：生成CSRF Token
- `validateCSRFToken($token)`：验证CSRF Token
- `sanitizeInput($input)`：清理输入内容
- `escapeOutput($output)`：转义输出内容

### RateLimiter类

位置：`core/RateLimiter.php`

主要方法：
- `checkRateLimit($key, $maxRequests, $windowSeconds)`：检查频率限制
- `resetRateLimit($key)`：重置频率限制

### ApiMiddleware类

位置：`core/ApiMiddleware.php`

主要方法：
- `checkSecurity($endpoint, $options)`：检查API安全性
  - `rate_limit`：是否启用频率限制
  - `csrf`：是否启用CSRF验证
  - `api_key`：是否启用API密钥验证
  - `signature`：是否启用签名验证

## 配置说明

### API安全配置

在`config/config.php`中配置：

```php
'api' => [
    'keys' => [], // API密钥列表
    'signature_secret' => '', // 请求签名密钥
    'require_signature' => false, // 是否要求请求签名
    'signature_time_window' => 300, // 签名时间窗口（秒）
],
```

### Session配置

在`config/config.php`中配置：

```php
'session' => [
    'name' => 'PHOTO_UPLOAD_SESSION',
    'lifetime' => 7200, // 2小时
],
```

## 使用示例

### API频率限制

```php
// 在API接口中使用中间件
$middleware = new ApiMiddleware();
$securityCheck = $middleware->checkSecurity('api/login.php', [
    'rate_limit' => true,
    'csrf' => false
]);

if ($securityCheck) {
    // 返回错误（频率限制等）
    echo json_encode($securityCheck);
    exit;
}
```

### CSRF防护

```php
// 生成Token
$token = Security::generateCSRFToken();

// 在表单中包含Token
// <input type="hidden" name="csrf_token" value="<?php echo $token; ?>">

// 验证Token
if (!Security::validateCSRFToken($_POST['csrf_token'])) {
    // Token验证失败
    return ['success' => false, 'message' => 'CSRF验证失败'];
}
```

### 密码验证

```php
// 加密密码
$hashedPassword = password_hash($password, PASSWORD_DEFAULT);

// 验证密码
if (password_verify($password, $hashedPassword)) {
    // 密码正确
}
```

## 最佳实践

1. **使用HTTPS**：在生产环境中使用HTTPS加密传输
2. **定期更新密码**：建议用户定期更新密码
3. **限制登录尝试**：限制失败登录次数，防止暴力破解
4. **监控异常行为**：定期检查异常行为日志
5. **保持系统更新**：及时更新PHP和依赖库
6. **权限最小化**：只给用户和程序最小必要的权限
7. **输入验证**：验证所有用户输入
8. **输出转义**：转义所有输出内容

## 注意事项

1. **频率限制**：频率限制基于IP，可能影响同一IP的多个用户
2. **CSRF Token**：CSRF Token需要存储在Session中
3. **密码强度**：密码强度验证可以配置规则
4. **文件上传**：文件上传需要严格验证，防止恶意文件
5. **Session安全**：Session配置需要正确设置，防止会话劫持
6. **日志记录**：安全日志需要定期检查和清理

