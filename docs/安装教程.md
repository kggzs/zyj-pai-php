# 安装教程

## 📋 前置要求

### 系统要求

#### 基础要求
- ✅ PHP 7.2 或更高版本
- ✅ MySQL 5.6 或更高版本
- ✅ Apache/Nginx Web服务器

#### PHP扩展
- ✅ PDO
- ✅ PDO_MySQL
- ✅ GD库（图片处理）
- ✅ EXIF扩展（EXIF数据解析，可选）
- ✅ Session支持
- ✅ JSON支持
- ✅ mbstring（多字节字符串处理）

---

## 🚀 安装步骤

### 1️⃣ 环境检测

#### PHP环境检测

访问环境检测脚本检查 PHP 环境是否满足要求：

```bash
http://your-domain/check_php_env.php
```

该脚本会检查：
- PHP 版本
- 必需的 PHP 扩展
- 目录权限
- 配置文件状态

#### 服务器时间同步

如果服务器时间不准确，可以使用时间同步工具检查和同步时间：

```bash
http://your-domain/check_time_sync.php
```

该工具使用阿里云 NTP 服务器 (`ntp.aliyun.com`) 进行时间同步，功能包括：
- 显示当前服务器时间
- 获取 NTP 服务器时间并对比差异
- 提供系统级别的时间同步命令（需要 root 权限）

**推荐在服务器上配置自动时间同步：**

<details>
<summary><strong>Linux (使用 chronyd，推荐)</strong></summary>

```bash
# 安装 chrony
sudo apt-get install -y chrony  # Ubuntu/Debian
sudo yum install -y chrony      # CentOS/RHEL

# 配置使用阿里云 NTP
sudo sed -i 's/^pool.*/server ntp.aliyun.com iburst/' /etc/chrony.conf

# 重启服务
sudo systemctl restart chronyd
sudo systemctl enable chronyd
```
</details>

<details>
<summary><strong>Linux (使用 ntpdate)</strong></summary>

```bash
# 安装 ntpdate
sudo apt-get install -y ntpdate  # Ubuntu/Debian
sudo yum install -y ntpdate      # CentOS/RHEL

# 立即同步
sudo ntpdate -u ntp.aliyun.com

# 设置定时任务（每小时同步）
sudo crontab -e
# 添加: 0 * * * * /usr/sbin/ntpdate -u ntp.aliyun.com >/dev/null 2>&1
```
</details>

---

### 2️⃣ 数据库配置

#### 创建数据库

推荐使用最新版本初始化脚本：

```bash
mysql -u root -p < database/init_latest.sql
```

或者手动创建数据库：

```sql
CREATE DATABASE xiaochuo CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

然后导入数据库结构：

```bash
mysql -u root -p xiaochuo < database/init_latest.sql
```

#### 配置数据库连接

1. 复制数据库配置示例文件：

```bash
cp config/database.php.example config/database.php
```

2. 编辑 `config/database.php`，修改数据库连接信息：

```php
return [
    'host' => 'localhost',        // 数据库主机
    'dbname' => 'xiaochuo',       // 数据库名称
    'username' => 'root',         // 数据库用户名
    'password' => 'your_password', // 数据库密码
    'charset' => 'utf8mb4',       // 字符集
];
```

**安全提示：**
- 确保 `config/database.php` 文件权限设置为 600 或 640
- 不要将数据库配置文件提交到版本控制系统

---

### 3️⃣ 系统配置

#### 站点URL配置（可选）

编辑 `config/config.php`，配置站点URL（留空则自动检测）：

```php
'site_url' => 'http://your-domain.com',
```

如果留空，系统会自动检测当前访问的域名。

---

### 4️⃣ 目录权限

#### 设置目录权限

确保以下目录具有写入权限：

```bash
# 设置上传目录权限
chmod -R 755 uploads/
chown -R www-data:www-data uploads/  # 根据实际Web服务器用户调整

# 设置缓存目录权限
chmod -R 755 cache/
chown -R www-data:www-data cache/    # 根据实际Web服务器用户调整
```

**需要写入权限的目录：**
- `uploads/original/` - 原图上传目录
- `uploads/video/` - 视频上传目录
- `cache/` - 缓存目录

#### 权限说明

- **755**：目录权限，所有者可读写执行，组和其他用户可读执行
- **644**：文件权限，所有者可读写，组和其他用户可读

**Windows 环境：**
- 确保 IIS_IUSRS 或对应的 Web 服务器用户对目录有写入权限

---

### 5️⃣ 创建管理员账号

#### 方法一：使用创建脚本（推荐）

访问 `create_admin.php` 页面，通过两步验证创建管理员账号：

```bash
http://your-domain/create_admin.php
```

**使用步骤：**

1. **修改脚本专属密码**
   
   编辑 `create_admin.php` 文件，修改脚本专属密码：
   
   ```php
   define('SCRIPT_PASSWORD', 'Admin2024Secure!@#'); // 请修改此密码
   ```
   
   建议使用强密码，包含大小写字母、数字和特殊字符。

2. **访问创建页面**
   
   在浏览器中访问 `create_admin.php`

3. **验证脚本专属密码**
   
   输入修改后的脚本专属密码，点击"下一步"

4. **填写管理员信息**
   
   - **用户名**：3-20 个字符，只能包含字母、数字和下划线
   - **密码**：符合密码强度要求
   - **邮箱**：有效的邮箱地址

5. **完成创建**
   
   创建成功后，管理员账号将自动设置为永久 VIP 会员

> 📖 详细说明请参考 [创建管理员账号文档](创建管理员账号.md)

**安全建议：**
- 创建管理员账号后，建议删除或重命名 `create_admin.php` 文件
- 建议通过 IP 白名单或 .htaccess 限制访问

#### 方法二：通过数据库直接创建

1. **生成密码哈希**

   使用 PHP 生成密码哈希：

   ```php
   <?php
   echo password_hash('your_password', PASSWORD_DEFAULT);
   ?>
   ```

   或者使用命令行：

   ```bash
   php -r "echo password_hash('your_password', PASSWORD_DEFAULT);"
   ```

2. **插入管理员记录**

   ```sql
   INSERT INTO users (
       username, 
       password, 
       register_ip, 
       register_ua, 
       register_time, 
       last_login_time, 
       status, 
       is_admin, 
       points,
       is_vip,
       vip_expire_time
   ) VALUES (
       'admin', 
       'your_hashed_password', 
       '127.0.0.1', 
       'Admin Setup', 
       NOW(), 
       NOW(), 
       1, 
       1, 
       0,
       1,
       NULL
   );
   ```

#### 方法三：先注册普通用户，然后设置为管理员

1. **注册普通用户**

   通过注册页面注册一个普通账号

2. **设置为管理员**

   ```sql
   UPDATE users 
   SET is_admin = 1, is_vip = 1, vip_expire_time = NULL 
   WHERE username = 'your_username';
   ```

---

## ✅ 安装验证

### 检查清单

完成安装后，请检查以下项目：

- [ ] PHP 环境检测通过
- [ ] 数据库连接正常
- [ ] 目录权限设置正确
- [ ] 管理员账号创建成功
- [ ] 可以正常访问首页
- [ ] 可以正常登录管理员后台

### 测试步骤

1. **访问首页**
   ```
   http://your-domain/index.php
   ```

2. **测试用户注册**
   ```
   http://your-domain/register.php
   ```

3. **测试管理员登录**
   ```
   http://your-domain/admin_login.php
   ```

4. **检查上传功能**
   - 创建拍摄链接
   - 测试照片上传
   - 测试视频上传

---

## 🔧 常见问题

### 问题1：数据库连接失败

**可能原因：**
- 数据库配置信息错误
- 数据库服务未启动
- 数据库用户权限不足

**解决方法：**
1. 检查 `config/database.php` 配置是否正确
2. 确认数据库服务已启动
3. 检查数据库用户是否有相应权限

### 问题2：目录权限错误

**可能原因：**
- 目录权限设置不正确
- Web 服务器用户无写入权限

**解决方法：**
```bash
# 检查目录权限
ls -la uploads/
ls -la cache/

# 重新设置权限
chmod -R 755 uploads/
chmod -R 755 cache/
chown -R www-data:www-data uploads/
chown -R www-data:www-data cache/
```

### 问题3：上传失败

**可能原因：**
- PHP 上传文件大小限制
- 目录权限问题
- 磁盘空间不足

**解决方法：**
1. 检查 PHP 配置：
   ```ini
   upload_max_filesize = 50M
   post_max_size = 50M
   max_execution_time = 300
   ```

2. 检查目录权限（见问题2）

3. 检查磁盘空间：
   ```bash
   df -h
   ```

### 问题4：管理员账号创建失败

**可能原因：**
- 用户名已存在
- 邮箱已被使用
- 密码不符合要求

**解决方法：**
1. 检查用户名和邮箱是否已被使用
2. 确保密码符合强度要求（至少6个字符，建议包含大小写字母、数字和特殊字符）
3. 查看系统错误日志

---

## 🔒 安全建议

### 部署后安全检查

1. **删除或保护安装脚本**
   - 删除或重命名 `create_admin.php`
   - 删除或保护 `check_php_env.php`

2. **配置文件安全**
   - 确保 `config/database.php` 权限为 600 或 640
   - 不要将配置文件提交到版本控制系统

3. **目录权限**
   - 确保敏感文件不可通过 Web 访问
   - 使用 `.htaccess` 或 Nginx 配置限制访问

4. **HTTPS 配置**
   - 必须使用 HTTPS 访问系统
   - 配置 SSL 证书

5. **定期备份**
   - 定期备份数据库
   - 定期备份上传的文件

---

## 📚 相关文档

- [创建管理员账号](创建管理员账号.md) - 管理员账号创建详细说明
- [用户系统](用户系统.md) - 用户注册、登录等功能
- [管理员后台](管理员后台.md) - 后台管理功能说明

---

## 🆘 获取帮助

如果遇到问题：

1. **查看系统错误日志**
   - 管理员后台 → 系统日志
   - 服务器错误日志

2. **检查 PHP 环境**
   - 访问 `check_php_env.php`

3. **查看文档**
   - 参考 `docs/` 目录下的详细文档

4. **检查数据库**
   - 确认数据库表结构正确
   - 检查数据库连接配置
