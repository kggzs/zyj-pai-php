# 拍摄链接管理模块

拍摄链接管理模块负责拍摄链接的生成、验证、管理和使用。

## 功能概述

### 1. 拍摄链接码

拍摄链接码是8位字母数字组合，用于生成唯一的拍摄链接。

- **格式**：8位字母数字组合（0-9、a-z、A-Z）
- **唯一性**：每个拍摄链接码都是唯一的
- **用途**：用于照片/视频上传，通过拍摄链接访问

### 2. 拍摄链接生成

#### 生成规则

- **普通用户**：
  - 有数量限制（默认7个，可通过配置修改）
  - 可通过积分商城兑换额外配额
  - 默认有效期（默认7天，可通过配置修改）
  - 总配额 = 基础配额 + 额外配额

- **VIP用户**：
  - 无数量限制
  - 默认永久有效（expire_time为NULL）
  - 可设置永久有效或自定义有效期

#### 生成流程

1. 检查用户是否为VIP（包括检查VIP是否过期）
2. 如果不是VIP，检查是否达到生成上限
3. 计算总配额（基础配额 + 额外配额）
4. 生成唯一的8位拍摄链接码
5. 计算有效期（VIP默认永久，普通用户使用默认有效期）
6. 生成拍摄链接URL（照片链接和视频链接）
7. 保存到数据库

#### 拍摄链接URL

每个拍摄链接码对应两个URL：
- **照片拍摄链接**：`/invite.php?code=拍摄链接码`
- **视频拍摄链接**：`/record.php?code=拍摄链接码`

### 3. 拍摄链接管理

#### 链接状态

- `status = 1`：启用
- `status = 0`：禁用（VIP用户可操作）

#### 链接标签

- VIP用户可以为拍摄链接添加标签
- 标签用于分类和管理拍摄链接

#### 链接有效期

- **永久有效**：`expire_time`为NULL（仅VIP用户可设置）
- **临时有效**：`expire_time`为具体日期时间
- 过期后链接自动失效

#### 链接更新

VIP用户可以更新拍摄链接的：
- 标签（label）
- 状态（启用/禁用）

### 4. 拍摄链接验证

#### 验证规则

- 拍摄链接码必须为8位
- 链接状态必须为启用（status = 1）
- 链接必须未过期（expire_time为NULL或expire_time > NOW()）

#### 验证流程

1. 验证拍摄链接码格式（8位）
2. 查询数据库中的拍摄链接
3. 检查链接状态和有效期
4. 返回验证结果和链接信息

### 5. 上传统计

- 每个拍摄链接记录上传数量（upload_count）
- 每次上传成功后自动增加计数

## API接口

### 生成拍摄链接

**接口**：`POST /api/generate_invite.php`

**权限**：需要登录

**参数**：
- 无（使用默认配置）

**返回示例**：
```json
{
  "success": true,
  "invite_code": "AbCd1234",
  "invite_url": "http://example.com/invite.php?code=AbCd1234",
  "video_invite_url": "http://example.com/record.php?code=AbCd1234",
  "invite_id": 123,
  "expire_time": "2024-01-15 12:00:00",
  "is_unlimited": false
}
```

### 获取拍摄链接列表

**接口**：`GET /api/get_invites.php`

**权限**：需要登录

**参数**：
- `page`（可选）：页码（默认1）
- `page_size`（可选）：每页数量（默认20）

**返回示例**：
```json
{
  "success": true,
  "list": [
    {
      "id": 123,
      "invite_code": "AbCd1234",
      "invite_url": "http://example.com/invite.php?code=AbCd1234",
      "video_invite_url": "http://example.com/record.php?code=AbCd1234",
      "create_time": "2024-01-08 12:00:00",
      "expire_time": "2024-01-15 12:00:00",
      "status": 1,
      "upload_count": 10,
      "label": "活动链接"
    }
  ],
  "total": 5,
  "page": 1,
  "page_size": 20,
  "max_invites": 7,
  "base_max_invites": 7,
  "quota_bonus": 0,
  "can_generate": true
}
```

### 验证拍摄链接码

**接口**：`GET /api/validate_invite.php`

**参数**：
- `code`（必填）：拍摄链接码（8位）

**返回示例**：
```json
{
  "valid": true,
  "invite": {
    "id": 123,
    "invite_code": "AbCd1234",
    "user_id": 1,
    "status": 1,
    "expire_time": null
  }
}
```

### 更新拍摄链接

**接口**：`POST /api/update_invite.php`

**权限**：需要登录（仅VIP用户可操作）

**参数**：
- `invite_id`（必填）：拍摄链接ID
- `label`（可选）：标签
- `status`（可选）：状态（1启用，0禁用）

**返回示例**：
```json
{
  "success": true,
  "message": "更新成功"
}
```

## 数据库结构

### invites表

主要字段：
- `id`：拍摄链接ID（主键）
- `invite_code`：拍摄链接码（8位，唯一）
- `user_id`：用户ID
- `invite_url`：拍摄链接URL
- `create_time`：创建时间
- `expire_time`：过期时间（NULL表示永久有效）
- `status`：状态（0禁用，1启用）
- `upload_count`：上传数量
- `label`：标签（VIP用户可设置）

## 核心类

### Invite类

位置：`core/Invite.php`

主要方法：
- `generateInvite($userId, $customExpireTime)`：生成拍摄链接
- `validateInvite($inviteCode)`：验证拍摄链接码
- `getUserInvites($userId, $page, $pageSize)`：获取用户的拍摄链接列表
- `incrementUploadCount($inviteId)`：增加上传数量
- `updateInvite($inviteId, $userId, $label, $status)`：更新拍摄链接（VIP用户）

## 配置说明

### 系统配置

在`system_config`表中配置（通过`Helper::getConfigGroup('invite')`获取）：

- `invite_max_count`：普通用户最大拍摄链接数（默认7）
- `invite_default_expire_days`：默认有效期（天数，默认7）

### 配额说明

- **基础配额**：系统配置的最大拍摄链接数
- **额外配额**：用户通过积分商城兑换的配额（存储在`users.invite_quota_bonus`字段）
- **总配额**：基础配额 + 额外配额

## VIP特权

VIP用户享受以下特权：

1. **无限制生成**：不受数量限制
2. **永久有效**：默认生成永久有效的链接
3. **标签管理**：可以为链接添加标签
4. **启用/禁用**：可以启用或禁用链接

## 使用示例

### 生成拍摄链接

```php
// 用户登录后调用生成接口
// POST /api/generate_invite.php

// 系统检查用户配额和VIP状态
// 生成8位拍摄链接码
// 生成照片和视频链接URL
// 保存到数据库并返回结果
```

### 使用拍摄链接

```php
// 用户访问拍摄链接
// GET /invite.php?code=AbCd1234

// 系统验证链接码有效性
// 如果有效，显示拍摄页面
// 用户拍摄后自动上传
```

### 管理拍摄链接（VIP）

```php
// VIP用户更新链接
// POST /api/update_invite.php
// {
//   "invite_id": 123,
//   "label": "活动链接",
//   "status": 1
// }
```

## 注意事项

1. **链接码唯一性**：系统会确保每个拍摄链接码都是唯一的
2. **配额限制**：普通用户有数量限制，VIP用户无限制
3. **有效期管理**：过期链接自动失效，VIP用户可设置永久有效
4. **状态管理**：只有VIP用户可以启用/禁用链接
5. **上传统计**：每次上传成功会自动增加上传计数

