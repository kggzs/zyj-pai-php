# 📸 照片视频管理模块

照片视频管理模块负责照片和视频的上传、存储、管理和展示。

## ✨ 功能概述

### 📷 1. 照片上传

#### 🔄 上传流程
1. 用户访问拍摄链接（`/invite.php?code=拍摄链接码`）
2. 系统验证拍摄链接码有效性
3. 前端调用摄像头自动拍摄
4. 照片以Base64格式上传到服务器
5. 服务器处理照片（压缩、EXIF解析）
6. 保存照片文件到服务器
7. 保存照片信息到数据库
8. 处理积分奖励

#### 🛠️ 照片处理
- **图片压缩**：自动压缩照片以减小文件体积
- **尺寸限制**：最大宽度1280px，最大高度720px
- **格式支持**：JPEG、PNG
- **EXIF解析**：自动解析照片的EXIF数据

### 🎬 2. 视频上传

#### 🔄 上传流程
1. 用户访问视频拍摄链接（`/record.php?code=拍摄链接码`）
2. 系统验证拍摄链接码有效性
3. 前端调用摄像头录制视频
4. 视频以Blob格式上传到服务器
5. 保存视频文件到服务器
6. 保存视频信息到数据库（包括时长）
7. 处理积分奖励

#### 🛠️ 视频处理
- **格式支持**：WebM、MP4
- **大小限制**：最大20MB
- **时长限制**：默认最大60秒（可配置）
- **时长记录**：自动记录视频时长

### 📊 3. EXIF数据解析

#### 📋 支持的EXIF信息
- **GPS信息**：经纬度、海拔
- **相机信息**：相机品牌、型号、镜头型号
- **拍摄参数**：焦距、光圈、快门速度、ISO
- **其他信息**：曝光模式、白平衡、闪光灯、方向、尺寸
- **地理位置**：地址信息（如果配置了地理编码服务）

#### 🔄 EXIF解析流程
1. 上传照片时自动解析EXIF数据
2. 提取关键信息保存到数据库
3. 完整EXIF数据以JSON格式保存
4. 在照片详情页面显示EXIF信息

### 📁 4. 照片管理

#### 📋 照片列表
- 支持分页显示
- 按上传时间倒序排列
- 支持按拍摄链接码筛选
- 支持按标签筛选
- 显示拍摄链接标签（如果VIP用户设置了标签）

#### 🔍 照片详情
- 显示照片信息
- 显示EXIF数据（GPS、相机参数等）
- 显示上传时间、上传IP等
- 显示关联的标签

#### 🏷️ 照片标签
- 用户可以为照片添加标签
- 标签用于分类和管理照片
- 支持按标签筛选照片
- 标签最多10个字符

### ⚙️ 5. 照片操作

#### 🗑️ 删除照片
- **软删除**：用户删除照片时只标记删除，不删除文件
- **硬删除**：管理员可以硬删除照片（删除文件）
- 软删除的照片在用户列表中不显示，但管理员可以查看

#### ⬇️ 下载照片
- 支持单张照片下载
- VIP用户支持批量下载（最多100张）

#### 📦 批量操作
- **批量删除**：用户可以批量删除照片
- **批量下载**：VIP用户可以批量下载照片（最多100张）

## 🚀 API接口

### 📷 照片上传

**接口**：`POST /api/upload.php`

**参数**：
- `image`（必填）：Base64编码的照片数据
- `capture_code`（必填）：拍摄链接码（8位）

**返回示例**：
```json
{
  "success": true,
  "message": "上传成功",
  "photo_id": 123
}
```

### 🎬 视频上传

**接口**：`POST /api/upload_video.php`

**参数**：
- `video`（必填）：视频文件（Blob格式）
- `capture_code`（必填）：拍摄链接码（8位）
- `duration`（可选）：视频时长（秒）

**返回示例**：
```json
{
  "success": true,
  "message": "上传成功",
  "photo_id": 123
}
```

### 📋 获取照片列表

**接口**：`GET /api/get_photos.php`

**权限**：需要登录

**参数**：
- `page`（可选）：页码（默认1）
- `page_size`（可选）：每页数量（默认20）
- `tag_id`（可选）：标签ID筛选
- `invite_code`（可选）：拍摄链接码筛选

**返回示例**：
```json
{
  "success": true,
  "list": [
    {
      "id": 123,
      "invite_code": "AbCd1234",
      "file_type": "photo",
      "original_path": "/uploads/original/xxx.jpg",
      "upload_time": "2024-01-08 12:00:00",
      "invite_label": "活动链接"
    }
  ],
  "total": 100,
  "page": 1,
  "page_size": 20
}
```

### 🔍 获取照片详情

**接口**：`GET /api/get_photo_detail.php`

**权限**：需要登录

**参数**：
- `id`（必填）：照片ID

**返回示例**：
```json
{
  "success": true,
  "photo": {
    "id": 123,
    "invite_code": "AbCd1234",
    "file_type": "photo",
    "original_path": "/uploads/original/xxx.jpg",
    "upload_time": "2024-01-08 12:00:00",
    "latitude": 39.9042,
    "longitude": 116.4074,
    "camera_make": "Apple",
    "camera_model": "iPhone 12",
    "focal_length": "4.2",
    "aperture": "1.6",
    "shutter_speed": "1/120",
    "iso": 100
  }
}
```

### 🗑️ 删除照片

**接口**：`POST /api/delete_photo.php`

**权限**：需要登录

**参数**：
- `photo_id`（必填）：照片ID

### 📦 批量删除照片

**接口**：`POST /api/batch_delete_photos.php`

**权限**：需要登录

**参数**：
- `photo_ids`（必填）：照片ID数组（JSON格式）

### ⬇️ 批量下载照片

**接口**：`POST /api/batch_download_photos.php`

**权限**：需要登录（VIP用户）

**参数**：
- `photo_ids`（必填）：照片ID数组（JSON格式，最多100张）

### 🏷️ 添加照片标签

**接口**：`POST /api/add_photo_tag.php`

**权限**：需要登录

**参数**：
- `photo_id`（必填）：照片ID
- `tag_name`（必填）：标签名称（最多10个字符）

### 🏷️ 删除照片标签

**接口**：`POST /api/remove_photo_tag.php`

**权限**：需要登录

**参数**：
- `photo_id`（必填）：照片ID
- `tag_id`（必填）：标签ID

### 🏷️ 获取标签列表

**接口**：`GET /api/get_tags.php`

**权限**：需要登录

**返回示例**：
```json
{
  "success": true,
  "tags": [
    {
      "id": 1,
      "name": "活动",
      "photo_count": 10
    }
  ]
}
```

### 🔍 查看照片

**接口**：`GET /api/view_photo.php`

**权限**：需要登录

**参数**：
- `id`（必填）：照片ID

**返回**：照片文件流

## 🗄️ 数据库结构

### 📸 photos表

主要字段：
- `id`：照片ID（主键）
- `invite_id`：拍摄链接ID
- `invite_code`：拍摄链接码（8位）
- `user_id`：用户ID
- `original_path`：原图路径
- `result_path`：处理后图片路径（暂未使用）
- `file_type`：文件类型（"photo"或"video"）
- `video_duration`：视频时长（秒，仅视频）
- `upload_ip`：上传IP
- `upload_ua`：上传User-Agent
- `upload_time`：上传时间
- `deleted_at`：删除时间（NULL表示未删除，软删除）
- **EXIF字段**：
  - `latitude`：纬度
  - `longitude`：经度
  - `altitude`：海拔
  - `camera_make`：相机品牌
  - `camera_model`：相机型号
  - `lens_model`：镜头型号
  - `focal_length`：焦距
  - `aperture`：光圈
  - `shutter_speed`：快门速度
  - `iso`：ISO
  - `exposure_mode`：曝光模式
  - `white_balance`：白平衡
  - `flash`：闪光灯
  - `orientation`：方向
  - `width`：宽度
  - `height`：高度
  - `location_address`：地理位置地址
  - `exif_data`：完整EXIF数据（JSON格式）

### 🏷️ tags表

标签表：
- `id`：标签ID（主键）
- `name`：标签名称
- `user_id`：用户ID

### 🔗 photo_tag_relations表

照片标签关联表：
- `id`：记录ID（主键）
- `photo_id`：照片ID
- `tag_id`：标签ID

## 🧰 核心类

### 📷 Photo类

位置：`core/Photo.php`

主要方法：
- `savePhoto($inviteId, $inviteCode, $userId, $originalPath, $uploadIp, $uploadUa, $exifData)`：保存照片信息
- `saveVideo($inviteId, $inviteCode, $userId, $originalPath, $duration, $uploadIp, $uploadUa)`：保存视频信息
- `getUserPhotos($userId, $page, $pageSize, $inviteCode, $tagName)`：获取用户照片列表
- `getPhotoById($photoId, $userId, $includeDeleted)`：获取照片详情
- `softDeletePhoto($photoId, $userId)`：软删除照片
- `hardDeletePhoto($photoId)`：硬删除照片（管理员）
- `addTagToPhoto($photoId, $tagName, $userId)`：添加照片标签
- `removeTagFromPhoto($photoId, $tagId, $userId)`：删除照片标签

### 🛠️ ImageProcessor类

位置：`core/ImageProcessor.php`

主要方法：
- `processImageBinary($imageData, $inviteCode)`：处理图片二进制数据
- `saveOriginalImage($imageData, $inviteCode)`：保存原图

### 📊 ExifParser类

位置：`core/ExifParser.php`

主要方法：
- `parseExif($imagePath, $imageData)`：解析EXIF数据
- `getLocationAddress($latitude, $longitude)`：根据经纬度获取地址

## ⚙️ 配置说明

### 📁 上传配置

在`config/config.php`中配置：

- `upload.max_size`：照片最大大小（字节，默认1MB）
- `upload.video_max_size`：视频最大大小（字节，默认20MB）
- `upload.allowed_types`：允许的照片类型
- `upload.allowed_video_types`：允许的视频类型
- `video.max_duration`：视频最大时长（秒，默认60）

### 🖼️ 图片处理配置

- `image.use_webp`：是否使用WebP格式（默认false）
- `image.jpeg_quality`：JPEG压缩质量（1-100，默认75）
- `image.webp_quality`：WebP压缩质量（1-100，默认75）
- `image.max_width`：最大宽度（默认1280px）
- `image.max_height`：最大高度（默认720px）

## 📝 使用示例

### 📷 上传照片

```php
// 1. 用户访问拍摄链接
// GET /invite.php?code=AbCd1234

// 2. 前端自动拍摄并上传
// POST /api/upload.php
// {
//   "image": "data:image/jpeg;base64,...",
//   "capture_code": "AbCd1234"
// }

// 3. 服务器处理照片
// - 解析EXIF数据
// - 压缩照片
// - 保存文件
// - 保存数据库记录
// - 处理积分奖励
```

### 📁 管理照片

```php
// 获取照片列表
// GET /api/get_photos.php?page=1&page_size=20

// 添加标签
// POST /api/add_photo_tag.php
// {
//   "photo_id": 123,
//   "tag_name": "活动"
// }

// 删除照片
// POST /api/delete_photo.php
// {
//   "photo_id": 123
// }
```

## ⚠️ 注意事项

1. **文件存储**：照片和视频存储在`uploads/original/`和`uploads/video/`目录
2. **软删除**：用户删除照片时只标记删除，不删除文件，管理员可以硬删除
3. **EXIF数据**：需要PHP的EXIF扩展支持，如果没有扩展，EXIF解析会失败但不影响上传
4. **批量下载**：只有VIP用户可以批量下载照片，最多100张
5. **文件大小限制**：注意PHP配置中的`upload_max_filesize`和`post_max_size`
6. **目录权限**：确保上传目录有写权限

