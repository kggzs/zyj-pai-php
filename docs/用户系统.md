# 👤 用户系统模块

用户系统模块负责用户的注册、登录、资料管理、邮箱验证等功能。

## ✨ 功能概述

### 📝 1. 用户注册

#### 注册流程
1. 用户填写注册信息（用户名、密码、邮箱（可选）、注册码（可选））
2. 系统验证信息格式和唯一性
3. 密码强度验证
4. 如果提供了注册码（6位）或拍摄链接码（8位），自动处理积分奖励
5. 如果开启了强制邮箱验证，发送验证码到邮箱
6. 创建用户账号并记录注册信息（IP、UA、时间等）

#### 注册规则
- **用户名规则**：
  - 长度：3-20个字符
  - 格式：只能包含字母、数字、下划线
  - 唯一性：不能与已有用户名重复

- **密码规则**：
  - 长度：至少6个字符
  - 强度验证：需包含字母和数字（可通过`Security::validatePasswordStrength`配置）

- **邮箱规则**：
  - 格式验证：使用PHP的`filter_var`验证邮箱格式
  - 唯一性：不能与已有邮箱重复
  - 可选：如果开启了强制邮箱验证，则邮箱为必填项

- **注册码/拍摄链接码**：
  - 支持6位注册码（用于邀请新用户）
  - 支持8位拍摄链接码（用于邀请新用户）
  - 使用注册码/拍摄链接码注册可获得积分奖励

#### 邮箱验证
- **强制验证模式**：系统配置`register_require_email_verification`为`1`时启用
- **验证流程**：
  1. 注册时发送验证码到邮箱
  2. 用户输入验证码完成验证
  3. 验证通过后才能登录
- **验证码有效期**：默认10分钟（可配置）

### 🔐 2. 用户登录

#### 登录方式
- **用户名登录**：使用用户名和密码登录
- **邮箱登录**：支持使用邮箱地址和密码登录

#### 登录流程
1. 验证用户名/邮箱和密码
2. 检查用户状态（是否被封禁）
3. 如果开启了强制邮箱验证，检查邮箱验证状态
4. 检查异常登录（新IP地址）
5. 记录登录日志
6. 更新最后登录时间和IP
7. 设置Session（重新生成Session ID防止会话固定攻击）

#### 🛡️ 安全特性
- **密码验证**：使用`password_verify`验证密码哈希
- **登录日志**：记录所有登录尝试（成功/失败）
- **异常登录检测**：检测新IP地址登录并记录异常行为
- **失败登录检测**：多次失败登录会被记录为异常行为
- **Session安全**：登录时重新生成Session ID

### 📋 3. 用户资料管理

#### 注册码
- 每个用户自动生成一个6位注册码
- 在用户个人资料页面显示
- 可用于邀请新用户注册

#### 昵称设置
- 用户可以设置昵称
- 昵称用于显示（如积分排行榜、公告等）

#### 邮箱管理
- **绑定邮箱**：用户可以绑定邮箱
- **邮箱验证**：绑定后需要验证才能使用邮箱功能
- **邮箱通知**：可以开启/关闭新照片上传的邮箱通知

### 🔑 4. 密码管理

#### 修改密码
- 用户登录后可以修改密码
- 需要验证当前密码
- 新密码需要满足强度要求

#### 重置密码
- 忘记密码时可以通过邮箱重置
- 流程：
  1. 输入邮箱地址
  2. 系统发送重置密码验证码
  3. 输入验证码和新密码
  4. 完成密码重置

### 📊 5. 登录日志

#### 日志记录
- 记录所有登录尝试（成功/失败）
- 记录登录IP、User-Agent、时间
- 记录失败原因（用户名不存在、密码错误、邮箱未验证等）

#### 日志查询
- 用户可以在个人中心查看自己的登录日志
- 管理员可以在后台查看所有用户的登录日志

## 🔌 API接口

### 用户注册

**接口**：`POST /api/register.php`

**参数**：
- `username`（必填）：用户名
- `password`（必填）：密码
- `email`（可选）：邮箱地址
- `invite_code`（可选）：注册码（6位）或拍摄链接码（8位）
- `agree_terms`（必填）：是否同意用户协议（值为"1"）

**返回示例**：
```json
{
  "success": true,
  "message": "注册成功",
  "user_id": 123,
  "require_verification": false
}
```

### 用户登录

**接口**：`POST /api/login.php`

**参数**：
- `username`（必填）：用户名或邮箱
- `password`（必填）：密码

**返回示例**：
```json
{
  "success": true,
  "message": "登录成功",
  "user": {
    "id": 123,
    "username": "testuser",
    "nickname": "测试用户",
    "email": "test@example.com",
    "points": 100
  }
}
```

### 获取用户注册码

**接口**：`GET /api/get_register_code.php`

**权限**：需要登录

**返回示例**：
```json
{
  "success": true,
  "register_code": "AbCd12"
}
```

### 设置昵称

**接口**：`POST /api/set_nickname.php`

**权限**：需要登录

**参数**：
- `nickname`（必填）：昵称（1-20个字符）

### 修改密码

**接口**：`POST /api/change_password.php`

**权限**：需要登录

**参数**：
- `old_password`（必填）：当前密码
- `new_password`（必填）：新密码

### 发送邮箱验证码

**接口**：`POST /api/send_email_code.php`

**权限**：需要登录（或注册时）

**参数**：
- `email`（必填）：邮箱地址
- `type`（可选）：验证类型（"verify"或"email"）

### 验证邮箱

**接口**：`POST /api/verify_email.php`

**权限**：需要登录

**参数**：
- `email`（必填）：邮箱地址
- `code`（必填）：验证码

### 设置邮箱通知

**接口**：`POST /api/set_email_notify.php`

**权限**：需要登录

**参数**：
- `enable`（必填）：是否开启（"1"开启，"0"关闭）

### 重置密码

**接口**：`POST /api/reset_password.php`

**参数**：
- `email`（必填）：邮箱地址
- `code`（必填）：验证码
- `new_password`（必填）：新密码

### 获取登录日志

**接口**：`GET /api/get_login_logs.php`

**权限**：需要登录

**参数**：
- `page`（可选）：页码（默认1）
- `page_size`（可选）：每页数量（默认20）

## 🗄️ 数据库结构

### users表

主要字段：
- `id`：用户ID（主键）
- `username`：用户名（唯一）
- `password`：密码哈希
- `nickname`：昵称
- `email`：邮箱地址
- `email_verified`：邮箱验证状态（0未验证，1已验证）
- `email_notify_photo`：邮箱通知开关（0关闭，1开启）
- `register_code`：注册码（6位，唯一）
- `register_ip`：注册IP
- `register_ua`：注册User-Agent
- `register_time`：注册时间
- `last_login_time`：最后登录时间
- `last_login_ip`：最后登录IP
- `status`：用户状态（0封禁，1正常）
- `is_admin`：是否为管理员（0否，1是）
- `is_vip`：是否为VIP（0否，1是）
- `vip_expire_time`：VIP到期时间（NULL表示永久）
- `points`：积分
- `invite_quota_bonus`：拍摄链接额外配额

### email_verification_codes表

邮箱验证码表：
- `id`：记录ID（主键）
- `user_id`：用户ID
- `email`：邮箱地址
- `code`：验证码
- `type`：验证类型（"verify"或"email"）
- `used`：是否已使用（0未使用，1已使用）
- `expire_time`：过期时间
- `create_time`：创建时间

### login_logs表

登录日志表：
- `id`：记录ID（主键）
- `user_id`：用户ID（NULL表示用户名不存在）
- `login_ip`：登录IP
- `login_ua`：登录User-Agent
- `login_time`：登录时间
- `success`：是否成功（0失败，1成功）
- `fail_reason`：失败原因

## 🧰 核心类

### User类

位置：`core/User.php`

主要方法：
- `register($username, $password, $inviteCode, $email)`：用户注册
- `login($username, $password)`：用户登录
- `getCurrentUser()`：获取当前登录用户
- `isLoggedIn()`：检查是否已登录
- `setNickname($userId, $nickname)`：设置昵称
- `changePassword($userId, $oldPassword, $newPassword)`：修改密码
- `sendEmailVerificationCode($userId, $email, $type)`：发送邮箱验证码
- `verifyEmail($userId, $email, $code, $type)`：验证邮箱
- `resetPassword($email, $code, $newPassword)`：重置密码
- `setEmailNotify($userId, $enable)`：设置邮箱通知
- `logLogin($userId, $ip, $ua, $success, $failReason)`：记录登录日志

## 安全特性

1. **密码安全**
   - 使用`password_hash`加密密码
   - 密码强度验证
   - 密码重置需要邮箱验证

2. **Session安全**
   - 登录时重新生成Session ID
   - Session配置安全参数

3. **登录安全**
   - 登录日志记录
   - 异常登录检测
   - 失败登录检测

4. **邮箱验证**
   - 验证码有效期限制
   - 验证码使用后失效
   - 防止重复使用

5. **API安全**
   - API频率限制
   - 输入验证和过滤
   - SQL注入防护（PDO预处理）

## ⚙️ 配置说明

### 系统配置

在`system_config`表中配置：

- `register_require_email_verification`：是否强制邮箱验证（"0"关闭，"1"开启）

### 邮件配置

在`system_config`表中配置SMTP服务器信息（详见邮件发送模块文档）。

## 📚 使用示例

### 用户注册流程

```php
// 1. 用户填写注册信息并提交
// 前端调用 /api/register.php

// 2. 如果开启了强制邮箱验证
// 系统发送验证码到邮箱

// 3. 用户输入验证码
// 调用 /api/verify_email.php 完成验证

// 4. 验证成功后可以登录
```

### 用户登录流程

```php
// 1. 用户输入用户名/邮箱和密码
// 调用 /api/login.php

// 2. 系统验证身份
// 如果开启了强制邮箱验证，检查邮箱验证状态

// 3. 登录成功，设置Session
// 用户可以访问需要登录的功能
```

## ⚠️ 注意事项

1. **邮箱验证**：如果开启了强制邮箱验证，未验证邮箱的用户无法登录
2. **注册码唯一性**：每个用户的注册码是唯一的，系统自动生成
3. **密码重置**：重置密码需要验证邮箱，确保账号安全
4. **登录日志**：所有登录尝试都会被记录，包括失败的登录
5. **异常登录**：系统会检测异常登录（如新IP地址）并记录为异常行为

