# 积分商城模块

积分商城模块负责商品的管理的兑换。

## 功能概述

### 1. 商品类型

- **临时VIP**（`vip_temporary`）：临时VIP会员（需要设置天数）
- **永久VIP**（`vip_permanent`）：永久VIP会员
- **拍摄链接配额**（`invite_limit`）：拍摄链接额外配额（需要设置数量）

### 2. 商品管理

#### 商品属性
- 商品名称
- 商品描述（支持纯文本、HTML、Markdown）
- 商品类型
- 积分价格
- 商品数值（临时VIP天数、配额数量）
- 总库存（可选，NULL表示无限制）
- 每用户限购（可选，NULL表示无限制）
- 排序顺序
- 上架/下架状态

#### 商品状态
- **上架**（status = 1）：用户可以兑换
- **下架**（status = 0）：用户不能兑换

### 3. 商品兑换

#### 兑换流程
1. 用户选择商品
2. 检查商品状态（是否上架）
3. 检查库存（如果有库存限制）
4. 检查用户限购（如果有限购）
5. 检查用户积分是否足够
6. 扣除用户积分
7. 发放商品（设置VIP、增加配额等）
8. 记录兑换日志

#### 兑换限制
- 商品必须上架
- 用户积分必须足够
- 必须满足库存限制（如果有）
- 必须满足用户限购（如果有）

## API接口

### 获取商品列表

**接口**：`GET /api/get_shop_products.php`

**返回示例**：
```json
{
  "success": true,
  "products": [
    {
      "id": 1,
      "name": "7天VIP",
      "description": "7天VIP会员",
      "type": "vip_temporary",
      "points_price": 100,
      "value": 7,
      "status": 1
    }
  ]
}
```

### 兑换商品

**接口**：`POST /api/exchange_shop_product.php`

**权限**：需要登录

**参数**：
- `product_id`（必填）：商品ID

**返回示例**：
```json
{
  "success": true,
  "message": "兑换成功",
  "product": {
    "name": "7天VIP",
    "type": "vip_temporary",
    "value": 7
  }
}
```

## 数据库结构

### points_shop表

商品表：
- `id`：商品ID（主键）
- `name`：商品名称
- `description`：商品描述
- `description_type`：描述类型（"plain"、"html"、"markdown"、"auto"）
- `type`：商品类型（"vip_temporary"、"vip_permanent"、"invite_limit"）
- `points_price`：积分价格
- `value`：商品数值（临时VIP天数、配额数量）
- `total_stock`：总库存（NULL表示无限制）
- `max_per_user`：每用户限购（NULL表示无限制）
- `sort_order`：排序顺序
- `status`：状态（0下架，1上架）

### points_exchange_log表

兑换记录表：
- `id`：记录ID（主键）
- `user_id`：用户ID
- `shop_id`：商品ID
- `points_cost`：消耗积分
- `product_type`：商品类型
- `product_value`：商品数值
- `create_time`：创建时间

## 核心类

### Shop类

位置：`core/Shop.php`

主要方法：
- `getProducts($status)`：获取商品列表
- `exchangeProduct($userId, $productId)`：兑换商品
- `addProduct(...)`：添加商品（管理员）
- `updateProduct(...)`：更新商品（管理员）
- `deleteProduct($id)`：删除商品（管理员）

## 使用示例

### 兑换商品流程

```php
// 1. 获取商品列表
// GET /api/get_shop_products.php

// 2. 选择商品并兑换
// POST /api/exchange_shop_product.php
// {
//   "product_id": 1
// }

// 3. 系统检查并处理
// - 检查商品状态
// - 检查库存和限购
// - 检查用户积分
// - 扣除积分
// - 发放商品（设置VIP、增加配额等）
// - 记录兑换日志
```

## 注意事项

1. **商品类型**：不同类型的商品需要不同的处理逻辑
2. **库存管理**：库存为NULL表示无限制
3. **限购管理**：每用户限购为NULL表示无限制
4. **积分扣除**：兑换时会扣除用户积分
5. **兑换记录**：所有兑换都有详细记录

