# 积分系统模块

积分系统模块负责积分的获取、消费、记录和排行榜等功能。

## 功能概述

### 1. 积分获取方式

#### 注册奖励
- 新用户注册时获得初始积分（默认10分，可配置）

#### 邀请奖励
- **通过注册码注册**：
  - 新用户使用注册码注册，新用户获得积分（默认5分）
  - 注册码拥有者获得邀请奖励（默认5分）
- **通过拍摄链接码注册**：
  - 新用户使用拍摄链接码注册，新用户获得积分（默认5分）
  - 拍摄链接码拥有者获得邀请奖励（默认5分）

#### 上传奖励
- 通过拍摄链接上传照片/视频获得积分（默认2分，可配置）

#### 签到奖励
- **基础奖励**：每日签到获得基础积分（默认5分）
- **VIP额外奖励**：VIP用户签到额外获得积分（默认3分）
- **连续签到奖励**：
  - 普通用户：连续3/7/15/30天额外奖励5/10/20/50分
  - VIP用户：连续3/7/15/30天额外奖励8/15/30/80分

### 2. 积分消费

- 在积分商城兑换商品（VIP、拍摄链接配额等）

### 3. 积分记录

所有积分变动都会记录到`points_log`表，包括：
- 积分类型（type）
- 积分数量（points，正数表示增加，负数表示减少）
- 备注说明（remark）
- 关联用户（new_user_id，如邀请奖励）
- 关联码（invite_code，注册码或拍摄链接码）
- 创建时间（create_time）

### 4. 积分排行榜

支持四种排行榜：
- **总积分排行榜**：按用户总积分排序
- **月度积分排行榜**：按本月获得的积分排序
- **邀请人数排行榜**：按邀请新用户数量排序
- **上传照片数排行榜**：按上传照片数量排序

## API接口

### 获取积分信息

**接口**：`GET /api/get_points.php`

**权限**：需要登录

**返回示例**：
```json
{
  "success": true,
  "points": 100,
  "points_log": {
    "list": [...],
    "total": 50,
    "page": 1,
    "page_size": 20
  }
}
```

### 每日签到

**接口**：`POST /api/do_checkin.php`

**权限**：需要登录

**返回示例**：
```json
{
  "success": true,
  "message": "签到成功",
  "data": {
    "points": 13,
    "base_points": 5,
    "vip_bonus": 3,
    "consecutive_bonus": 5,
    "consecutive_days": 3,
    "total_points": 113
  }
}
```

### 检查签到状态

**接口**：`GET /api/check_checkin_status.php`

**权限**：需要登录

**返回示例**：
```json
{
  "success": true,
  "checked_in": false,
  "consecutive_days": 2
}
```

### 获取签到历史

**接口**：`GET /api/get_checkin_history.php`

**权限**：需要登录

**参数**：
- `page`（可选）：页码（默认1）
- `page_size`（可选）：每页数量（默认30）

### 获取排行榜

**接口**：`GET /api/get_ranking.php`

**参数**：
- `type`（必填）：排行榜类型（"total"、"month"、"invite"、"upload"）
- `limit`（可选）：返回数量（默认100）

**返回示例**：
```json
{
  "success": true,
  "ranking": [
    {
      "id": 1,
      "username": "user1",
      "nickname": "用户1",
      "points": 1000,
      "is_vip_active": true
    }
  ],
  "user_rank": {
    "rank": 5,
    "count": 800
  }
}
```

## 数据库结构

### points_log表

积分变动明细表：
- `id`：记录ID（主键）
- `user_id`：用户ID
- `type`：积分类型（"register_reward"、"invite_reward"、"upload_reward"、"checkin_reward"、"shop_exchange"等）
- `points`：积分数量（正数增加，负数减少）
- `remark`：备注说明
- `new_user_id`：关联的新用户ID（如邀请奖励）
- `invite_code`：关联码（注册码或拍摄链接码）
- `create_time`：创建时间

### checkins表

签到记录表：
- `id`：记录ID（主键）
- `user_id`：用户ID
- `checkin_date`：签到日期
- `consecutive_days`：连续签到天数
- `points_earned`：获得的积分
- `created_at`：创建时间

## 核心类

### Points类

位置：`core/Points.php`

主要方法：
- `getUserPoints($userId)`：获取用户积分总额
- `getPointsLog($userId, $page, $pageSize)`：获取积分变动明细
- `addPoints($userId, $points, $type, $remark, $newUserId, $inviteCode)`：增加积分
- `deductPoints($userId, $points, $type, $remark)`：扣除积分
- `doCheckin($userId, $isVip)`：执行签到
- `checkCheckinStatus($userId)`：检查签到状态
- `getCheckinHistory($userId, $page, $pageSize)`：获取签到历史
- `getTotalPointsRanking($limit)`：获取总积分排行榜
- `getMonthlyPointsRanking($year, $month, $limit)`：获取月度积分排行榜
- `getInviteRanking($limit)`：获取邀请人数排行榜
- `getPhotoCountRanking($limit)`：获取上传照片数排行榜

## 配置说明

### 积分配置

在`system_config`表中配置（通过`Helper::getConfigGroup('points')`获取）：

- `points_register_reward`：注册奖励积分（默认10）
- `points_invite_reward`：邀请新用户注册奖励（邀请人，默认5）
- `points_invite_new_user_reward`：通过邀请码注册奖励（新用户，默认5）
- `points_upload_reward`：上传照片/视频奖励（默认2）
- `points_checkin_reward`：每日签到基础奖励（默认5）
- `points_checkin_vip_bonus`：VIP用户签到额外奖励（默认3）
- `points_checkin_consecutive_bonus`：普通用户连续签到奖励（JSON格式：{"3": 5, "7": 10, "15": 20, "30": 50}）
- `points_checkin_vip_consecutive_bonus`：VIP用户连续签到奖励（JSON格式：{"3": 8, "7": 15, "15": 30, "30": 80}）

## 使用示例

### 签到流程

```php
// 1. 检查签到状态
// GET /api/check_checkin_status.php

// 2. 执行签到
// POST /api/do_checkin.php

// 3. 系统计算积分
// - 基础积分
// - VIP额外奖励（如果是VIP）
// - 连续签到奖励（如果满足条件）
// - 更新用户积分
// - 记录签到和积分变动
```

### 查看积分明细

```php
// GET /api/get_points.php?page=1&page_size=20
// 返回积分总额和积分变动明细
```

## 注意事项

1. **连续签到**：中断后重新开始计算
2. **积分记录**：所有积分变动都有详细记录
3. **排行榜更新**：排行榜实时计算，不缓存
4. **积分消费**：积分不能为负数
5. **签到限制**：每日只能签到一次

